<section class="card">
  <h2 class="card-title">Workout plan</h2>

  <div class="field">
    <label>Plan type</label>
    <div class="theme-toggle">
      <button
        type="button"
        class="btn secondary"
        [class.active]="mode() === 'repeated'"
        (click)="mode.set('repeated')">
        Repeated
      </button>
      <button
        type="button"
        class="btn secondary"
        [class.active]="mode() === 'ramp-up'"
        (click)="mode.set('ramp-up')">
        Ramp-up
      </button>
    </div>
    <p class="hint" style="margin-top: 0.5rem;">
      @if (mode() === 'repeated') {
        Set your own distance for each running day. The same pattern repeats every week.
      } @else {
        Train towards a single goal run: we build a program that increases each week until your goal date.
      }
    </p>
  </div>

  <div class="field">
    <label>Available days (Mon–Sun)</label>
    <div class="theme-toggle">
      @for (day of dayNames; track day.value) {
        <button
          type="button"
          class="btn secondary"
          [class.active]="isDaySelected(day.value)"
          (click)="toggleDay(day.value)">
          {{ day.label }}
        </button>
      }
    </div>
  </div>

  @if (mode() === 'repeated') {
    <div class="field">
      <label>Distance per day (km)</label>
      <p class="hint">Set the distance for each day you run. Leave 0 to skip.</p>
      <div class="repeated-distances">
        @for (day of dayNames; track day.value) {
          @if (isDaySelected(day.value)) {
            <div class="distance-row">
              <span class="distance-label">{{ day.label }}</span>
              <input
                type="number"
                min="0"
                step="0.5"
                [ngModel]="getDistanceForDay(day.value)"
                (ngModelChange)="setDistanceForDay(day.value, $event)"
                placeholder="0" />
              <span class="distance-unit">km</span>
            </div>
          }
        }
      </div>
    </div>
    <div class="field">
      <label for="weeks-to-show">Weeks to generate</label>
      <input
        id="weeks-to-show"
        type="number"
        min="1"
        max="52"
        [ngModel]="weeksToShow()"
        (ngModelChange)="weeksToShow.set($event)" />
    </div>
  } @else {
    <div class="field">
      <label>Long run days</label>
      <p class="hint">Which of your available days get the ramping distance. Other days stay at or below 50% of that week's long run.</p>
      <div class="theme-toggle">
        @for (day of dayNames; track day.value) {
          <button
            type="button"
            class="btn secondary"
            [class.active]="isLongRunDay(day.value)"
            [disabled]="!isDaySelected(day.value)"
            (click)="toggleLongRunDay(day.value)"
            [title]="isDaySelected(day.value) ? '' : 'Select as available day first'">
            {{ day.label }}
          </button>
        }
      </div>
    </div>
    <div class="field">
      <label for="goal-date">Goal date</label>
      <input
        id="goal-date"
        type="date"
        [ngModel]="goalDate()"
        (ngModelChange)="goalDate.set($event)" />
      <p class="hint">Date of your target long run.</p>
    </div>
    <div class="field">
      <label for="goal-distance">Goal distance (km)</label>
      <input
        id="goal-distance"
        type="number"
        min="0.1"
        step="0.5"
        [ngModel]="goalDistanceKm()"
        (ngModelChange)="goalDistanceKm.set($event)" />
      <p class="hint">Distance of the single run on the goal date.</p>
    </div>
    <div class="field">
      <label for="start-distance">Starting distance (km)</label>
      <input
        id="start-distance"
        type="number"
        min="0"
        step="0.5"
        [ngModel]="startDistanceKm()"
        (ngModelChange)="startDistanceKm.set($event)" />
      <p class="hint">Week 1 long run distance. We increase each week until the goal.</p>
    </div>
  }

  <div class="actions">
    <button type="button" class="btn primary" (click)="generatePlan()">Generate plan</button>
  </div>
</section>

<section class="card">
  <h2 class="card-title">Your schedule</h2>
  @if (runnerPlan.userHasGenerated() && editableRuns().length > 0) {
    <p class="hint">Edit distances or remove runs below, then add to Google Calendar when ready.</p>
    <div class="schedule-calendar-wrap">
      <table class="schedule-calendar">
        <thead>
          <tr>
            <th class="week-col">Week</th>
            @for (day of dayNames; track day.value) {
              <th>{{ day.label }}</th>
            }
          </tr>
        </thead>
        <tbody>
          @for (row of calendarRows(); track row.weekMonday) {
            <tr>
              <td class="week-col">{{ row.weekLabel }}</td>
              @for (day of dayNames; track day.value) {
                <td>
                  @if (row.days[day.value]; as run) {
                    <div class="schedule-cell">
                      <span class="schedule-date">{{ run.date }}</span>
                      <input
                        type="number"
                        class="schedule-distance"
                        min="0"
                        step="0.5"
                        [ngModel]="run.distanceKm"
                        (ngModelChange)="updateRunDistance(run.date, $event)"
                        title="Distance (km)" />
                      <span class="schedule-unit">km</span>
                      <button
                        type="button"
                        class="btn btn-icon"
                        (click)="removeRun(run.date)"
                        title="Remove this run">
                        Remove
                      </button>
                    </div>
                  } @else {
                    <span class="schedule-empty">—</span>
                  }
                </td>
              }
            </tr>
          }
        </tbody>
      </table>
    </div>
    <div class="field" style="margin-top: 1rem;">
      <label for="event-colour">Event colour</label>
      <select
        id="event-colour"
        class="form-select"
        [ngModel]="runnerPlan.eventColorId()"
        (ngModelChange)="runnerPlan.setEventColorId($event)">
        @for (opt of calendarEventColors; track opt.id) {
          <option [value]="opt.id">{{ opt.label }}</option>
        }
      </select>
    </div>
    <div class="actions" style="margin-top: 1rem;">
      <button
        type="button"
        class="btn primary"
        (click)="addToCalendar()"
        [disabled]="calendarStatus() === 'sending'">
        @switch (calendarStatus()) {
          @case ('sending') { Adding… }
          @case ('done') { Added to calendar }
          @default { Add to Google Calendar }
        }
      </button>
      @if (runnerPlan.calendarEventIds().length > 0) {
        <button
          type="button"
          class="btn secondary"
          (click)="removeFromCalendar()"
          [disabled]="calendarStatus() === 'sending'">
          Remove runs from calendar
        </button>
      }
    </div>
    @if (calendarMessage(); as msg) {
      <p [class.error-msg]="calendarStatus() === 'error'" class="hint" style="margin-top: 0.5rem;">{{ msg }}</p>
    }
  } @else if (runnerPlan.userHasGenerated()) {
    <p class="hint">
      @if (mode() === 'repeated') {
        Choose at least one day and set a distance for each, then generate again.
      } @else {
        Choose available days, a goal date and goal distance, then generate again.
      }
    </p>
  } @else {
    <p class="hint">Set your options above and click <strong>Generate plan</strong> to see your schedule.</p>
  }
</section>
