<section class="card">
  <h2 class="card-title">Workout plan</h2>

  <div class="field">
    <label>Plan type</label>
    <div class="theme-toggle">
      <button
        type="button"
        class="btn secondary"
        [class.active]="mode() === 'repeated'"
        (click)="mode.set('repeated')">
        Repeated
      </button>
      <button
        type="button"
        class="btn secondary"
        [class.active]="mode() === 'smart'"
        (click)="mode.set('smart')">
        Smart plan
      </button>
    </div>
    <p class="hint" style="margin-top: 0.5rem;">
      @if (mode() === 'repeated') {
        Set your own distance for each running day. The same pattern repeats every week.
      } @else {
        Download a template file, edit the runs (or use a GenAI assistant), then import the JSON to add your plan.
      }
    </p>
  </div>

  @if (mode() === 'repeated') {
    <div class="field">
      <label>Available days (Mon–Sun)</label>
      <div class="theme-toggle">
        @for (day of dayNames; track day.value) {
          <button
            type="button"
            class="btn secondary"
            [class.active]="isDaySelected(day.value)"
            (click)="toggleDay(day.value)">
            {{ day.label }}
          </button>
        }
      </div>
    </div>
    <div class="field">
      <label>Distance per day (km)</label>
      <p class="hint">Set the distance for each day you run. Leave 0 to skip.</p>
      <div class="repeated-distances">
        @for (day of dayNames; track day.value) {
          @if (isDaySelected(day.value)) {
            <div class="distance-row">
              <span class="distance-label">{{ day.label }}</span>
              <input
                type="number"
                min="0"
                step="0.5"
                [ngModel]="getDistanceForDay(day.value)"
                (ngModelChange)="setDistanceForDay(day.value, $event)"
                placeholder="0" />
              <span class="distance-unit">km</span>
            </div>
          }
        }
      </div>
    </div>
    <div class="field">
      <label for="weeks-to-show">Weeks to generate</label>
      <input
        id="weeks-to-show"
        type="number"
        min="1"
        max="52"
        [ngModel]="weeksToShow()"
        (ngModelChange)="weeksToShow.set($event)" />
    </div>
    <div class="actions">
      <button type="button" class="btn primary" (click)="generatePlan()">Generate plan</button>
    </div>
  } @else {
    <div class="field">
      <label>Import smart plan</label>
      <p class="hint">Download the template (e.g. marathon plan), adjust dates and runs if needed, then upload the JSON.</p>
      <div class="settings-import-actions" style="margin-top: 0.5rem;">
        <button type="button" class="btn secondary" (click)="downloadTemplate()">Download template</button>
        <label class="btn secondary" [class.disabled]="uploading()">
          {{ uploading() ? 'Importing…' : 'Upload plan' }}
          <input
            type="file"
            accept=".json,application/json"
            (change)="onFileSelected($event)"
            style="display: none;"
            [disabled]="uploading()" />
        </label>
      </div>
      @if (uploadMessage(); as msg) {
        <p class="hint" [class.error-msg]="uploadError()" style="margin-top: 0.5rem;">{{ msg }}</p>
      }
    </div>
  }
</section>

<section class="card">
  <h2 class="card-title">Google Calendar</h2>
  @if (runnerPlan.userHasGenerated() && schedule().length > 0) {
    <p class="hint">Your plan has {{ schedule().length }} run(s). Add them to Google Calendar below, or edit your plan in the <strong>Your plan</strong> view.</p>
    <div class="field" style="margin-top: 1rem;">
      <label for="event-colour">Event colour</label>
      <select
        id="event-colour"
        class="form-select"
        [ngModel]="runnerPlan.eventColorId()"
        (ngModelChange)="runnerPlan.setEventColorId($event)">
        @for (opt of calendarEventColors; track opt.id) {
          <option [value]="opt.id">{{ opt.label }}</option>
        }
      </select>
    </div>
    <div class="actions" style="margin-top: 1rem;">
      <button
        type="button"
        class="btn primary"
        (click)="addToCalendar()"
        [disabled]="calendarStatus() === 'sending'">
        @switch (calendarStatus()) {
          @case ('sending') { Adding… }
          @case ('done') { Added to calendar }
          @default { Add to Google Calendar }
        }
      </button>
      @if (runnerPlan.calendarEventIds().length > 0) {
        <button
          type="button"
          class="btn secondary"
          (click)="removeFromCalendar()"
          [disabled]="calendarStatus() === 'sending'">
          Remove runs from calendar
        </button>
      }
    </div>
    @if (calendarMessage(); as msg) {
      <p [class.error-msg]="calendarStatus() === 'error'" class="hint" style="margin-top: 0.5rem;">{{ msg }}</p>
    }
  } @else if (runnerPlan.userHasGenerated()) {
    <p class="hint">Add runs to your plan: use <strong>Repeated</strong> and generate, or <strong>Smart plan</strong> and upload a JSON file.</p>
  } @else {
    <p class="hint">Choose <strong>Repeated</strong> and generate a plan, or use <strong>Smart plan</strong> to download a template and upload your JSON. You can also import from Runner settings.</p>
  }
</section>
